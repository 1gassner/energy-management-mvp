# FlowMind Universal Backend - Migration Guide\n\n## ðŸš€ Overview\n\nThis guide provides step-by-step instructions for migrating from separate frontend backends to the new **FlowMind Universal Backend** that supports all 4 frontends:\n\n- **FlowMind AI Chat** - Conversational AI interface\n- **Quantum Swarm** - Advanced swarm optimization\n- **Velocity Swarm** - Rapid task execution swarm\n- **CityPulse Energy Management** - Municipal energy monitoring\n\n## ðŸ“‹ Pre-Migration Checklist\n\n### Environment Requirements\n- [ ] Node.js 18+ installed\n- [ ] Supabase project configured\n- [ ] Environment variables configured\n- [ ] Database permissions verified\n- [ ] WebSocket support confirmed\n\n### Data Backup\n- [ ] Export existing user data\n- [ ] Backup current database schemas\n- [ ] Document custom configurations\n- [ ] Save API key configurations\n\n## ðŸ”§ Migration Steps\n\n### Phase 1: Database Migration\n\n#### 1.1 Deploy Universal Schema\n\n```bash\n# Connect to your Supabase project\nnpx supabase link --project-ref YOUR_PROJECT_REF\n\n# Apply the universal schema\nnpx supabase db push\n\n# Or manually execute the schema\npsql -h YOUR_HOST -U postgres -d postgres -f backend/database/universal-schema.sql\n```\n\n#### 1.2 Migrate Existing Data\n\n**For CityPulse Users:**\n```sql\n-- Migrate existing buildings (add user_id)\nUPDATE buildings \nSET user_id = 'YOUR_USER_UUID' \nWHERE user_id IS NULL;\n\n-- Migrate sensors\nUPDATE sensors \nSET status = 'active' \nWHERE status IS NULL;\n```\n\n**For FlowMind Users:**\n```sql\n-- Migrate chat sessions\nINSERT INTO chat_sessions (id, user_id, title, model_id, created_at)\nSELECT id, user_id, title, model_id, created_at \nFROM old_chat_sessions;\n```\n\n**For Swarm Users:**\n```sql\n-- Migrate swarm tasks\nINSERT INTO swarm_tasks (id, user_id, type, objective, config, status, created_at)\nSELECT id, user_id, type, objective, config, status, created_at \nFROM old_swarm_tasks;\n```\n\n### Phase 2: Backend Deployment\n\n#### 2.1 Environment Configuration\n\nCreate `.env` file:\n```bash\n# Core Configuration\nNODE_ENV=production\nPORT=8000\nHOST=0.0.0.0\n\n# Database\nSUPABASE_URL=https://your-project.supabase.co\nSUPABASE_ANON_KEY=your-anon-key\nSUPABASE_SERVICE_ROLE_KEY=your-service-role-key\n\n# Authentication\nJWT_SECRET=your-super-secure-jwt-secret\nJWT_EXPIRES_IN=24h\nJWT_REFRESH_SECRET=your-refresh-secret\nJWT_REFRESH_EXPIRES_IN=7d\n\n# Security\nBCRYPT_ROUNDS=12\nRATE_LIMITING_ENABLED=true\n\n# CORS\nALLOWED_ORIGINS=https://flowmind.app,https://quantum.app,https://velocity.app,https://citypulse.app\n\n# Features (Enable/Disable per environment)\nAI_MODELS_ENABLED=true\nQUANTUM_SWARM_ENABLED=true\nVELOCITY_SWARM_ENABLED=true\nCITYPULSE_ENABLED=true\nWEBSOCKET_ENABLED=true\n\n# Logging\nLOG_LEVEL=info\n\n# External Services\nOPENAI_API_KEY=your-openai-key\nANTHROPIC_API_KEY=your-anthropic-key\nGROQ_API_KEY=your-groq-key\n```\n\n#### 2.2 Install and Start Backend\n\n```bash\n# Install dependencies\ncd backend\nnpm install\n\n# Run database migrations\nnpm run migrate\n\n# Seed initial data (optional)\nnpm run seed\n\n# Start in development\nnpm run dev\n\n# Start in production\nnpm start\n```\n\n### Phase 3: Frontend Integration\n\n#### 3.1 Update API Base URLs\n\n**Old Configuration:**\n```javascript\n// FlowMind\nconst API_BASE = 'https://flowmind-api.app'\n\n// CityPulse\nconst API_BASE = 'https://citypulse-api.app'\n\n// Quantum Swarm\nconst API_BASE = 'https://quantum-api.app'\n```\n\n**New Universal Configuration:**\n```javascript\n// All frontends now use the same backend\nconst API_BASE = 'https://universal-api.flowmind.app'\n\n// Frontend-specific routes\nconst ENDPOINTS = {\n  auth: '/api/v1/auth',\n  ai: '/api/v1/ai',           // FlowMind\n  swarm: '/api/v1/swarm',     // Quantum & Velocity\n  citypulse: '/api/v1/citypulse', // CityPulse\n  shared: '/api/v1/shared'    // Cross-frontend\n}\n```\n\n#### 3.2 Update Authentication\n\n**New JWT Token Format:**\n```javascript\n// Token now includes frontend permissions\nconst token = localStorage.getItem('auth_token')\n\n// Set frontend source header\nconst headers = {\n  'Authorization': `Bearer ${token}`,\n  'X-Frontend-Source': 'citypulse', // or 'flowmind', 'quantum', 'velocity'\n  'Content-Type': 'application/json'\n}\n```\n\n#### 3.3 WebSocket Integration\n\n**New WebSocket Setup:**\n```javascript\nimport { io } from 'socket.io-client'\n\n// Connect to appropriate namespace\nconst socket = io('https://universal-api.flowmind.app/citypulse', {\n  auth: {\n    token: localStorage.getItem('auth_token')\n  }\n})\n\n// Frontend-specific event handling\nsocket.on('connect', () => {\n  console.log('Connected to CityPulse namespace')\n  \n  // Subscribe to building updates\n  socket.emit('join_building', buildingId)\n})\n\nsocket.on('energy:update', (data) => {\n  // Handle real-time energy updates\n  updateEnergyDashboard(data)\n})\n```\n\n### Phase 4: Production Deployment\n\n#### 4.1 Docker Deployment\n\n**Dockerfile:**\n```dockerfile\nFROM node:18-alpine\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\nRUN npm ci --only=production\n\n# Copy application\nCOPY . .\n\n# Create non-root user\nRUN addgroup -g 1001 -S nodejs\nRUN adduser -S nodejs -u 1001\nUSER nodejs\n\nEXPOSE 8000\n\nCMD [\"npm\", \"start\"]\n```\n\n**docker-compose.yml:**\n```yaml\nversion: '3.8'\n\nservices:\n  universal-backend:\n    build: .\n    ports:\n      - \"8000:8000\"\n    environment:\n      - NODE_ENV=production\n      - SUPABASE_URL=${SUPABASE_URL}\n      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}\n      - JWT_SECRET=${JWT_SECRET}\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8000/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n```\n\n#### 4.2 Nginx Configuration\n\n```nginx\nserver {\n    listen 80;\n    server_name universal-api.flowmind.app;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name universal-api.flowmind.app;\n\n    ssl_certificate /path/to/certificate.crt;\n    ssl_certificate_key /path/to/private.key;\n\n    # WebSocket support\n    location /socket.io/ {\n        proxy_pass http://localhost:8000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n\n    # API routes\n    location /api/ {\n        proxy_pass http://localhost:8000;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        \n        # CORS headers\n        add_header Access-Control-Allow-Origin *;\n        add_header Access-Control-Allow-Methods \"GET, POST, PUT, DELETE, OPTIONS\";\n        add_header Access-Control-Allow-Headers \"DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Frontend-Source\";\n        \n        if ($request_method = 'OPTIONS') {\n            return 204;\n        }\n    }\n\n    # Health check\n    location /health {\n        proxy_pass http://localhost:8000;\n        access_log off;\n    }\n}\n```\n\n## ðŸ”„ Migration Timeline\n\n### Week 1: Preparation\n- [ ] Set up new universal backend environment\n- [ ] Test database schema migration\n- [ ] Configure CI/CD pipelines\n- [ ] Prepare rollback procedures\n\n### Week 2: Staged Migration\n- [ ] **Day 1-2**: Deploy to staging environment\n- [ ] **Day 3-4**: Frontend teams update API integrations\n- [ ] **Day 5-6**: End-to-end testing\n- [ ] **Day 7**: Performance and load testing\n\n### Week 3: Production Rollout\n- [ ] **Day 1**: Database migration (maintenance window)\n- [ ] **Day 2**: Backend deployment\n- [ ] **Day 3**: Frontend deployments (gradual rollout)\n- [ ] **Day 4-5**: Monitor and optimize\n- [ ] **Day 6-7**: Cleanup old infrastructure\n\n## ðŸ” Testing Checklist\n\n### Backend Testing\n- [ ] Health check endpoints responding\n- [ ] Authentication working for all frontends\n- [ ] WebSocket connections stable\n- [ ] Database queries performing well\n- [ ] Rate limiting functioning\n- [ ] Error handling working correctly\n\n### Frontend Testing\n- [ ] Login/logout flows working\n- [ ] API calls returning expected data\n- [ ] Real-time features functioning\n- [ ] Cross-frontend integrations working\n- [ ] Performance acceptable\n- [ ] Error states handled gracefully\n\n### Integration Testing\n- [ ] User can switch between frontends seamlessly\n- [ ] Shared data synchronizing correctly\n- [ ] Notifications working across frontends\n- [ ] Security policies enforced\n- [ ] Analytics tracking properly\n\n## ðŸ› Troubleshooting\n\n### Common Issues\n\n**\"Frontend access denied\" errors:**\n```sql\n-- Check user's organization features\nSELECT features FROM organizations \nWHERE id = (SELECT organization_id FROM user_profiles WHERE id = 'USER_ID');\n\n-- Enable missing frontend\nUPDATE organizations \nSET features = features || '{\"citypulse\": true}' \nWHERE id = 'ORG_ID';\n```\n\n**WebSocket connection failures:**\n```javascript\n// Check token validity\nconst token = localStorage.getItem('auth_token')\nif (!token || isTokenExpired(token)) {\n  // Refresh token or redirect to login\n  await refreshAuthToken()\n}\n```\n\n**Database connection issues:**\n```bash\n# Test Supabase connection\ncurl -H \"Authorization: Bearer YOUR_ANON_KEY\" \\\n     \"https://YOUR_PROJECT.supabase.co/rest/v1/organizations?select=id&limit=1\"\n```\n\n### Performance Issues\n\n**Slow API responses:**\n- Check database indexes are created\n- Verify connection pooling is configured\n- Monitor memory usage\n- Check for N+1 query problems\n\n**High memory usage:**\n- Monitor WebSocket connections\n- Check for memory leaks in event listeners\n- Verify garbage collection is working\n- Scale horizontally if needed\n\n## ðŸ“Š Monitoring Setup\n\n### Health Monitoring\n```bash\n# Basic health check\ncurl https://universal-api.flowmind.app/health\n\n# Detailed health check\ncurl https://universal-api.flowmind.app/api/v1/info\n```\n\n### Performance Monitoring\n- Set up Prometheus metrics collection\n- Configure Grafana dashboards\n- Set up alerting for critical metrics:\n  - Response time > 5 seconds\n  - Error rate > 5%\n  - Memory usage > 90%\n  - Database connection failures\n\n### Log Monitoring\n```bash\n# Monitor application logs\ntail -f /var/log/universal-backend/app.log\n\n# Monitor error logs\ntail -f /var/log/universal-backend/error.log\n\n# Monitor access logs\ntail -f /var/log/nginx/access.log\n```\n\n## ðŸ”„ Rollback Procedures\n\n### Emergency Rollback\nIf critical issues arise, follow this rollback procedure:\n\n1. **Immediate Actions:**\n   ```bash\n   # Switch traffic back to old backends\n   kubectl rollback deployment/universal-backend\n   \n   # Update DNS to point to old services\n   # Restore database from backup if needed\n   ```\n\n2. **Database Rollback:**\n   ```sql\n   -- If database changes need to be reverted\n   -- Run rollback migrations\n   -- Restore from backup if necessary\n   ```\n\n3. **Frontend Rollback:**\n   - Deploy previous frontend versions\n   - Update API endpoints to old backends\n   - Verify all functionality restored\n\n## ðŸ“ž Support\n\n### During Migration\n- **Technical Lead**: Contact for architecture questions\n- **DevOps Team**: Infrastructure and deployment issues\n- **Frontend Teams**: Integration and testing support\n- **QA Team**: Testing and validation support\n\n### Post-Migration\n- **Monitoring**: Set up 24/7 monitoring alerts\n- **On-Call**: Establish on-call rotation\n- **Documentation**: Update all technical documentation\n- **Training**: Conduct team training sessions\n\n## âœ… Success Criteria\n\nMigration is considered successful when:\n- [ ] All 4 frontends working correctly\n- [ ] Response times < 2 seconds for 95% of requests\n- [ ] Error rate < 1%\n- [ ] WebSocket connections stable\n- [ ] User authentication seamless\n- [ ] Data integrity maintained\n- [ ] All tests passing\n- [ ] Performance metrics within acceptable ranges\n- [ ] Team trained and confident with new system\n\n---\n\n**Migration Date**: Target completion by [DATE]\n**Migration Lead**: [NAME]\n**Review Date**: [DATE] - 1 week post-migration review\n\nFor questions or issues during migration, contact the engineering team at: engineering@flowmind.app